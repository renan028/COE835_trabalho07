%---------------------------------------------------------------------
\section{Backstepping - Formulação teórica}

Backstepping é um método recursivo de controle adaptativo baseado em Lyapunov e
proposto no começo da década de 90. A ideia é projetar um controle recursivo
considerando algumas das variáveis de estado como ``controle virtuais'' e
implementar para elas leis de controle intermediárias. Com esta técnica é
possível resolver problemas de estabilidade e rastreamento. Neste trabalho,
desenvolveremos a fundamentação teórica para o caso de um sistema de
segunda ordem com parâmetros desconhecidos:

\begin{align}
\dot{x}_1 &= x_2 + \phi_1^\intercal(x_1) \, \theta\\
\nonumber \dot{x}_2 &= k_p\,u + \phi_2^\intercal(x_1,x_2)\,\theta
\label{eq:planta}
\end{align}

onde $\theta$ é o vetor de parâmetros desconhecidos e $k_p$ é o ganho de
alta frequência, também desconhecido. As não linearidades do sistema são
representadas pela variável $\phi$. Para o desenvolvimento do algoritmo,
assume-se:

\begin{itemize}
  \item o sinal de $k_p$ é conhecido;
  \item o sinal de referência $y_r$ e suas derivadas são contínuas e limitadas.
\end{itemize}

Introduzem-se as variáveis $\textbf{z}$ (mudança de coordenadas):

\begin{align}
z_1 &= x_1 - y_r \\
\nonumber z_2 &= x_2 - \alpha_1 - \dot{y}_r,
\end{align}

onde $\alpha$ é a variável de controle virtual. O primeiro passo para a
elaboração do método é começar pela equação \ref{eq:planta},
considerando $x_2$ como uma variável de controle virtual. A derivada do erro de
rastreamento $z_1$ é dada por:

\begin{align}
\dot{z}_1 &= \dot{x}_1 - \dot{y}_r \\
\nonumber &= z_2 + \alpha_1 + \phi_1^\intercal\,\theta
\end{align}

Podemos projetar a primeira função estabilizante $\alpha_1$ como:

\begin{equation}
\alpha_1 = -c_1z_1 - \phi_1^\intercal\,\hat{\theta},
\end{equation}

onde $c_1$ é uma constante positiva e $\hat{\theta}$ é uma estimativa de
$\theta$. Consideremos a função de Lyapunov:

\begin{equation}
V_1 = \frac{1}{2}z_1^2 +
\frac{1}{2}\tilde{\theta}^\intercal\,\Gamma^{-1}\,\tilde{\theta},
\end{equation}

onde $\Gamma$ é uma matriz positiva definida e
$\tilde{\theta}=\theta-\hat{\theta}$. Derivando a função de Lyapunov, temos:

\begin{align}
\dot{V}_1 &= z_1\dot{z}_1 -
\tilde{\theta}^\intercal\,\Gamma^{-1}\,\dot{\hat{\theta}}\\
\nonumber &=
z_1(z_2+\alpha_1+\phi_1^\intercal
\, \hat{\theta})-\tilde{\theta}^\intercal(\Gamma^{-1} \,
\dot{\hat{\theta}}-\phi_1z_1)\\
\nonumber &= -c_1z_1^2+\tilde{\theta}^\intercal(\tau_1-\Gamma^{-1} \,
\dot{\hat{\theta}}) + z_1z_2\\
\tau_1 &= \phi_1z_1
\end{align}

Observe que se escolhermos a variação dos parâmetros como
$\dot{\hat{\theta}}=\Gamma\,\tau_1$ anulamos um dos termos, mas ainda falta
considerar a dinâmica de $z_2$. Devemos deixar a escolha da lei de adaptação em
aberto. Pela segunda equação, temos:

\begin{align}
\dot{z}_2 &= k_pu + \phi_2^\intercal \, \theta - \dot{\alpha_1}-\ddot{y}_r \\
\nonumber &= k_pu + \phi_2^\intercal \, \theta -
\frac{\partial\alpha_1}{\partial x_1}(x_2 + \phi_1^\intercal \, \theta) -
\frac{\partial\alpha_1}{\partial \hat{\theta}}\dot{\hat{\theta}} -
\frac{\partial\alpha_1}{\partial y_r}\dot{y}_r - \ddot{y}_r
\end{align}

Escolhemos a função Lyapunov:

\begin{align}
V = V_1 + \frac{1}{2}z_2^2 + \frac{|k_p|}{2\gamma}\tilde{p}^2, 
\end{align}

onde $\tilde{p}=p-\hat{p}$ e $\hat{p}$ é estimativa de $p = \frac{1}{k_p}$, e
$\gamma > 0$. Derivando a função Lyapunov, obtemos:

\begin{align}
\dot{V} &= -c_1z_1^2 + z_1z_2 +
\tilde{\theta}^\intercal(\tau_1-\Gamma^{-1}\dot{\hat{\theta}}) + z_2\dot{z}_2 +
\frac{|k_p|}{\gamma}\tilde{p}\dot{\tilde{p}} \notag\\
\nonumber &= -c_1z_1^2 + z_1z_2 +
\tilde{\theta}^\intercal(\tau_1-\Gamma^{-1}\dot{\hat{\theta}}) + z_2\left( k_pu
+ \phi_2^\intercal \, \theta - \frac{\partial\alpha_1}{\partial x_1}(x_2 + \phi_1^\intercal \, \theta) -
\frac{\partial\alpha_1}{\partial \hat{\theta}}\dot{\hat{\theta}} -
\frac{\partial\alpha_1}{\partial y_r}\dot{y}_r - \ddot{y}_r \right) +
\frac{|k_p|}{\gamma}\tilde{p}\dot{\tilde{p}} \\
\theta &= \tilde{\theta} + \hat{\theta} \notag\\
\dot{V} &= -c_1z_1^2 + z_1z_2 +
\tilde{\theta}^\intercal(\tau_1-\Gamma^{-1}\dot{\hat{\theta}}) + z_2\left( k_pu
+ (\tilde{\theta}^\intercal + \hat{\theta}^\intercal)(\phi_2 -
\frac{\partial\alpha_1}{\partial x_1}\phi_1) - \frac{\partial\alpha_1}{\partial
x_1}x_2 \right. \notag\\
&\phantom{{}=1} \left. - \frac{\partial\alpha_1}{\partial 
\hat{\theta}}\dot{\hat{\theta}} - \frac{\partial\alpha_1}{\partial y_r}\dot{y}_r - \ddot{y}_r \right) +
\frac{|k_p|}{\gamma}\tilde{p}\dot{\tilde{p}} \notag \\
\tau_2 &= \tau_1 + \left(\phi_2 - \frac{\partial\alpha_1}{\partial x_1}\phi_1
\right)z_2  \notag \\
\dot{V} &= -c_1z_1^2 + z_1z_2 +
\tilde{\theta}^\intercal(\tau_2-\Gamma^{-1}\dot{\hat{\theta}}) + z_2\left( k_pu
+ \hat{\theta}^\intercal(\phi_2 -
\frac{\partial\alpha_1}{\partial x_1}\phi_1) - \frac{\partial\alpha_1}{\partial
x_1}x_2 \right. \notag\\
&\phantom{{}=1} \left. - \frac{\partial\alpha_1}{\partial 
\hat{\theta}}\dot{\hat{\theta}} - \frac{\partial\alpha_1}{\partial y_r}\dot{y}_r - \ddot{y}_r \right) +
\frac{|k_p|}{\gamma}\tilde{p}\dot{\tilde{p}} \notag \\
\label{eq:dotV} 
\end{align}


Escolhemos a lei de controle:
\begin{align}
u &= \hat{p}\bar{u}\\
\bar{u} &= \alpha_2 + \ddot{y}_r
\end{align}

Note que:
\begin{equation}
 k_pu = k_p\hat{p}\bar{u}=\bar{u} - k_p\tilde{p}\bar{u}
 \label{eq:kpu}
\end{equation}

Substituindo a eq.\ref{eq:kpu} em eq.\ref{eq:dotV}, temos:

\begin{align}
\dot{V} &= -c_1z_1^2 + z_1z_2 +
\tilde{\theta}^\intercal(\tau_2-\Gamma^{-1}\dot{\hat{\theta}}) + z_2\left( \bar{u} - k_p\tilde{p}\bar{u}
+ \hat{\theta}^\intercal(\phi_2 -
\frac{\partial\alpha_1}{\partial x_1}\phi_1) - \frac{\partial\alpha_1}{\partial
x_1}x_2 \right. \notag\\
&\phantom{{}=1} \left. - \frac{\partial\alpha_1}{\partial 
\hat{\theta}}\dot{\hat{\theta}} - \frac{\partial\alpha_1}{\partial y_r}\dot{y}_r - \ddot{y}_r \right) +
\frac{|k_p|}{\gamma}\tilde{p}\dot{\tilde{p}} \notag \\
&= -c_1z_1^2 + z_1z_2 +
\tilde{\theta}^\intercal(\tau_2-\Gamma^{-1}\dot{\hat{\theta}}) + z_2\left( \bar{u} 
+ \hat{\theta}^\intercal(\phi_2 -
\frac{\partial\alpha_1}{\partial x_1}\phi_1) - \frac{\partial\alpha_1}{\partial
x_1}x_2 \right. \notag\\
&\phantom{{}=1} \left. - \frac{\partial\alpha_1}{\partial 
\hat{\theta}}\dot{\hat{\theta}} - \frac{\partial\alpha_1}{\partial y_r}\dot{y}_r - \ddot{y}_r \right) +
\frac{|k_p|}{\gamma}\tilde{p}\,\left(\dot{\tilde{p}}-\text{sign}(k_p)\gamma\bar{u}z_2
\right)
\\
\nonumber &= -c_1z_1^2 + z_1z_2 +
\tilde{\theta}^\intercal(\tau_2-\Gamma^{-1}\dot{\hat{\theta}}) + z_2\left( \alpha_2
+ \hat{\theta}^\intercal(\phi_2 -
\frac{\partial\alpha_1}{\partial x_1}\phi_1) - \frac{\partial\alpha_1}{\partial
x_1}x_2 \right. \notag\\
&\phantom{{}=1} \left. - \frac{\partial\alpha_1}{\partial 
\hat{\theta}}\dot{\hat{\theta}} - \frac{\partial\alpha_1}{\partial y_r}\dot{y}_r
\right) - \frac{|k_p|}{\gamma}\tilde{p} \,
\left(\dot{\hat{p}}+\text{sign}(k_p)\gamma\bar{u}z_2\right)
\label{eq:dotV2}
\end{align}

Escolhemos $\alpha_2$ como:

\begin{equation}
\alpha_2 = -c_2z_2 - z_1 - \hat{\theta}^\intercal(\phi_2 -
\frac{\partial\alpha_1}{\partial x_1}\phi_1) + \frac{\partial\alpha_1}{\partial
x_1}x_2 + \frac{\partial\alpha_1}{\partial \hat{\theta}}\dot{\hat{\theta}} +
\frac{\partial\alpha_1}{\partial y_r} \dot{y}_r
\label{eq:alpha2}
\end{equation}

Substituindo a eq.\ref{eq:alpha2} em eq.\ref{eq:dotV2}, obtemos:

\begin{align}
\dot{V} &= -c_1z_1^2 -c_2z_2^2 +
\tilde{\theta}^\intercal(\tau_2-\Gamma^{-1}\dot{\hat{\theta}}) -
\frac{|k_p|}{\gamma}\tilde{p} \,
\left(\dot{\hat{p}}+\text{sign}(k_p)\gamma\bar{u}z_2\right)
\end{align}

A lei de atualização dos parâmetros é, portanto:

\begin{align}
\dot{\hat{p}} &= -\gamma\text{sign}(k_p)\bar{u}z_2 \\
\dot{\hat{\theta}} &= \Gamma\tau_2 
\end{align}

Neste trabalho, consideramos o sistema:

\begin{align}
\dot{x}_1 &= x_2 - a_1y\\
\nonumber \dot{x}_2 &= k_p\,u - a_0y
\label{eq:planta2}
\end{align}

Neste caso específico, temos:
\begin{align}
\theta &= \left[ a_0 \quad a_1 \right]^\intercal\\
\nonumber \phi_1 &= \left[ 0 \quad -y \right]^\intercal\\
\nonumber \phi_2 &= \left[ -y \quad 0 \right]^\intercal
\end{align}